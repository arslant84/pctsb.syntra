// Test script for TSR auto-generation functionality
const { TSRAutoGenerationService } = require('../src/lib/tsr-auto-generation-service');

async function testAutoGeneration() {
  console.log('🚀 Testing TSR Auto-Generation Functionality...\n');

  // Mock TSR data that would trigger auto-generation
  const mockTsrData = {
    id: 'TSR-20250813-TEST-DOM-1234',
    travelType: 'Domestic',
    requestorName: 'John Doe',
    staffId: 'EMP001',
    department: 'Engineering',
    position: 'Software Engineer',
    purpose: 'Business meeting in Ashgabat',
    domesticTravelDetails: {
      companyTransportDetails: [
        {
          date: new Date('2025-08-15'),
          day: 'Friday',
          from: 'Kiyanly',
          to: 'Ashgabat',
          btNoRequired: 'BT001',
          accommodationTypeN: 'Hotel',
          address: 'City Center',
          remarks: 'Morning departure'
        }
      ],
      accommodationDetails: [
        {
          accommodationType: 'Hotel/Отели',
          checkInDate: new Date('2025-08-15'),
          checkOutDate: new Date('2025-08-16'),
          location: 'Ashgabat',
          placeOfStay: 'Grand Hotel',
          estimatedCostPerNight: 100,
          remarks: 'Standard room'
        }
      ]
    }
  };

  try {
    console.log('📋 Mock TSR Data:');
    console.log(JSON.stringify(mockTsrData, null, 2));
    console.log('\n🔄 Testing auto-generation...\n');

    // Test the auto-generation functionality
    const result = await TSRAutoGenerationService.autoGenerateRequests(mockTsrData, 'test-user');
    
    console.log('✅ Auto-generation completed successfully!');
    console.log(`📊 Results:`);
    console.log(`   - Transport requests generated: ${result.transportRequests.length}`);
    console.log(`   - Accommodation requests generated: ${result.accommodationRequests.length}`);
    
    if (result.transportRequests.length > 0) {
      console.log(`   - Transport request IDs: ${result.transportRequests.join(', ')}`);
    }
    
    if (result.accommodationRequests.length > 0) {
      console.log(`   - Accommodation request IDs: ${result.accommodationRequests.join(', ')}`);
    }

    // Test fetching auto-generated requests
    console.log('\n🔍 Testing fetch auto-generated requests...');
    const fetchedRequests = await TSRAutoGenerationService.getAutoGeneratedRequests(mockTsrData.id);
    
    console.log('📋 Fetched auto-generated requests:');
    console.log(`   - Transport requests: ${fetchedRequests.transportRequests.length}`);
    console.log(`   - Accommodation requests: ${fetchedRequests.accommodationRequests.length}`);

  } catch (error) {
    console.error('❌ Auto-generation test failed:');
    console.error('Error:', error.message);
    console.error('Stack:', error.stack);
  }
}

// Run the test
if (require.main === module) {
  testAutoGeneration()
    .then(() => {
      console.log('\n🎉 Test completed!');
      process.exit(0);
    })
    .catch((error) => {
      console.error('\n💥 Test failed:', error);
      process.exit(1);
    });
}

module.exports = { testAutoGeneration };